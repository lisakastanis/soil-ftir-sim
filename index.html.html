<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soil FTIR Absorbance Simulator — Offline</title>
  <style>
    :root { --bg:#ffffff; --ink:#111827; --muted:#6b7280; --panel:#ffffff; --line:#e5e7eb; --grid:#eef2f7; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width:1200px; margin:0 auto; padding:16px; }
    h1 { font-size:22px; margin:6px 0 2px; }
    .grid { display:grid; grid-template-columns:340px 1fr; gap:16px; margin-top:12px; }
    .card { background:var(--panel); border:1px solid var(--line); border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); padding:14px; }
    .section-title { font-weight:600; margin:6px 0 6px; }
    .row { margin:8px 0; }
    .label { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
    .val { font-variant-numeric:tabular-nums; color:#374151; font-size:12px; }
    input[type="range"] { width:100%; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    button { background:#111827; color:#fff; border:0; border-radius:10px; padding:6px 10px; font-size:12px; cursor:pointer; }
    button:active { transform:translateY(1px); }
    .legend { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:6px; }
    .legend-item { display:flex; align-items:center; gap:8px; font-size:12px; }
    .swatch { width:22px; height:4px; border-radius:2px; background:#000; }
    svg { width:100%; height:560px; display:block; background:#f9fafb; border-radius:14px; }
    .axis text { font-size:12px; fill:#374151; }
    .gridline { stroke:var(--grid); stroke-width:1; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Soil FTIR Absorbance Simulator</h1>

    <div class="grid">
      <!-- Controls -->
      <div class="card">
        <div class="section-title">Components — Clays & Water</div>
        <div class="row"><div class="label"><span style="color:#e11d48">Montmorillonite</span><span id="val_mont" class="val">0.80</span></div><input id="mont" type="range" min="0" max="1.5" step="0.01" value="0.8"></div>
        <div class="row"><div class="label"><span style="color:#16a34a">Kaolinite</span><span id="val_kaol" class="val">0.60</span></div><input id="kaol" type="range" min="0" max="1.5" step="0.01" value="0.6"></div>
        <div class="row"><div class="label"><span style="color:#2563eb">Chlorite</span><span id="val_chl" class="val">0.40</span></div><input id="chl" type="range" min="0" max="1.5" step="0.01" value="0.4"></div>
        <div class="row"><div class="label"><span style="color:#9333ea">Illite</span><span id="val_ill" class="val">0.50</span></div><input id="ill" type="range" min="0" max="1.5" step="0.01" value="0.5"></div>
        <div class="row"><div class="label"><span style="color:#f59e0b">Interlayer water (1630)</span><span id="val_iw" class="val">0.60</span></div><input id="iw" type="range" min="0" max="1.5" step="0.01" value="0.6"></div>
        <div class="row"><div class="label"><span style="color:#0ea5e9">Adsorbed water (~3400)</span><span id="val_aw" class="val">0.70</span></div><input id="aw" type="range" min="0" max="1.5" step="0.01" value="0.7"></div>

        <div class="section-title" style="margin-top:14px">Components — Nutrients & Organics</div>
        <div class="row"><div class="label"><span style="color:#0d9488">Organic matter</span><span id="val_org" class="val">0.60</span></div><input id="org" type="range" min="0" max="1.5" step="0.01" value="0.6"></div>
        <div class="row"><div class="label"><span style="color:#dc2626">Nitrate</span><span id="val_nit" class="val">0.50</span></div><input id="nit" type="range" min="0" max="1.5" step="0.01" value="0.5"></div>
        <div class="row"><div class="label"><span style="color:#4f46e5">Bound orthophosphate</span><span id="val_pho" class="val">0.50</span></div><input id="pho" type="range" min="0" max="1.5" step="0.01" value="0.5"></div>

        <div class="section-title" style="margin-top:14px">Baseline & Display</div>
        <div class="row"><div class="label"><span>Baseline offset</span><span id="val_bo" class="val">0.020</span></div><input id="bo" type="range" min="0" max="0.2" step="0.001" value="0.02"></div>
        <div class="row"><div class="label"><span>Baseline slope</span><span id="val_bs" class="val">0.00003</span></div><input id="bs" type="range" min="-0.0001" max="0.00015" step="0.000001" value="0.00003"></div>
        <div class="controls row">
          <label><input id="normalize" type="checkbox"> Normalize total (max = 1.0)</label>
          <label><input id="showComps" type="checkbox" checked> Show component traces</label>
          <button id="reset">Reset</button>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="legend" id="legend"></div>
        </div>
      </div>

      <!-- Chart -->
      <div class="card">
        <svg id="chart" viewBox="0 0 900 560" preserveAspectRatio="none" aria-label="FTIR spectrum chart"></svg>
        <div class="sub" style="margin-top:6px">Model initialized using FTIR data sampled from organic farms in the SUNY Oneonta area.</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const gauss = (x, mu, sigma) => Math.exp(-0.5 * ((x - mu) / sigma) ** 2);
  const lorentz = (x, mu, gamma) => (gamma*gamma) / ((x - mu)*(x - mu) + gamma*gamma);

  const defs = {
    montmorillonite: { color: "#e11d48", peaks:[
      {fn:gauss, mu:1045, w:85, a:1.0}, {fn:gauss, mu:1115, w:95, a:0.6}, {fn:gauss, mu:915, w:40, a:0.4}, {fn:gauss, mu:3620, w:35, a:0.25}
    ]},
    kaolinite: { color: "#16a34a", peaks:[
      {fn:gauss, mu:1030, w:70, a:1.0}, {fn:gauss, mu:1110, w:80, a:0.5}, {fn:gauss, mu:915, w:30, a:0.35}, {fn:gauss, mu:3695, w:20, a:0.35}, {fn:gauss, mu:3620, w:18, a:0.25}
    ]},
    chlorite: { color: "#2563eb", peaks:[
      {fn:gauss, mu:1005, w:75, a:0.9}, {fn:gauss, mu:1060, w:75, a:0.7}, {fn:gauss, mu:3530, w:40, a:0.25}
    ]},
    illite: { color: "#9333ea", peaks:[
      {fn:gauss, mu:1000, w:80, a:0.8}, {fn:gauss, mu:3620, w:35, a:0.2}
    ]},
    interlayerWater: { color: "#f59e0b", peaks:[
      {fn:gauss, mu:1630, w:120, a:1.0}, {fn:gauss, mu:2070, w:200, a:0.2}
    ]},
    adsorbedWater: { color: "#0ea5e9", peaks:[
      {fn:lorentz, mu:3400, w:230, a:1.0}
    ]},
    organicMatter: { color: "#0d9488", peaks:[
      {fn:gauss, mu:1715, w:60, a:0.6}, {fn:gauss, mu:1620, w:80, a:0.5}, {fn:gauss, mu:1515, w:70, a:0.35}, {fn:gauss, mu:1420, w:50, a:0.35}, {fn:gauss, mu:1230, w:60, a:0.35}, {fn:gauss, mu:1030, w:65, a:0.45}
    ]},
    nitrate: { color: "#dc2626", peaks:[
      {fn:gauss, mu:1384, w:40, a:1.0}, {fn:gauss, mu:824, w:30, a:0.5}
    ]},
    phosphateBound: { color: "#4f46e5", peaks:[
      {fn:gauss, mu:1085, w:55, a:0.9}, {fn:gauss, mu:1040, w:55, a:0.7}, {fn:gauss, mu:980, w:45, a:0.6}, {fn:gauss, mu:565, w:35, a:0.35}
    ]}
  };

  const WN = []; for(let x=4000; x>=500; x-=2) WN.push(x);

  const chart = document.getElementById('chart');
  const inputs = {
    mont: qs('#mont'), kaol: qs('#kaol'), chl: qs('#chl'), ill: qs('#ill'),
    iw: qs('#iw'), aw: qs('#aw'), org: qs('#org'), nit: qs('#nit'), pho: qs('#pho'),
    bo: qs('#bo'), bs: qs('#bs'), normalize: qs('#normalize'), showComps: qs('#showComps'), reset: qs('#reset')
  };
  const labels = {
    mont: qs('#val_mont'), kaol: qs('#val_kaol'), chl: qs('#val_chl'), ill: qs('#val_ill'),
    iw: qs('#val_iw'), aw: qs('#val_aw'), org: qs('#val_org'), nit: qs('#val_nit'), pho: qs('#val_pho'),
    bo: qs('#val_bo'), bs: qs('#val_bs')
  };
  const legend = document.getElementById('legend');
  function qs(s){ return document.querySelector(s); }

  const legendItems = [
    ['Montmorillonite', defs.montmorillonite.color],
    ['Kaolinite', defs.kaolinite.color],
    ['Chlorite', defs.chlorite.color],
    ['Illite', defs.illite.color],
    ['Interlayer water', defs.interlayerWater.color],
    ['Adsorbed water', defs.adsorbedWater.color],
    ['Organic matter', defs.organicMatter.color],
    ['Nitrate', defs.nitrate.color],
    ['Bound orthophosphate', defs.phosphateBound.color],
    ['Baseline (dashed)', '#64748b'],
    ['Total', '#111827']
  ];
  for(const [name,color] of legendItems){
    const item = document.createElement('div'); item.className='legend-item';
    const sw = document.createElement('div'); sw.className='swatch'; sw.style.background = color; item.appendChild(sw);
    const sp = document.createElement('span'); sp.textContent = name; item.appendChild(sp);
    legend.appendChild(item);
  }

  const M = { l:60, r:20, t:20, b:42 };
  const W = 900, H = 560; const IW = W - M.l - M.r, IH = H - M.t - M.b;
  function xPx(wn){ const t = (4000 - wn) / (4000 - 500); return M.l + t * IW; }
  function yPx(v, yMax){ const t = v / (yMax || 1e-9); return M.t + (1 - t) * IH; }
  function pathFrom(xs, ys, yMax){ let d=''; for(let i=0;i<xs.length;i++){ const x=xPx(xs[i]), y=yPx(ys[i],yMax); d += (i?' L':'M') + x + ' ' + y; } return d; }
  function clearChart(){ chart.innerHTML=''; }
  function svgEl(name, attrs){ const el = document.createElementNS('http://www.w3.org/2000/svg', name); for(const k in attrs) el.setAttribute(k, attrs[k]); return el; }

  function drawAxes(yMax){
    for(let tick=4000; tick>=500; tick-=500){
      const x = xPx(tick);
      chart.appendChild(svgEl('line', { x1:x, x2:x, y1:M.t, y2:M.t+IH, class:'gridline' }));
      chart.appendChild(svgEl('text', { x:x, y:M.t+IH+18, 'text-anchor':'middle' })).textContent = tick;
    }
    chart.appendChild(svgEl('text', { x:M.l+IW/2, y:H-6, 'text-anchor':'middle' })).textContent = 'Wavenumber (cm⁻¹)';

    const ticks = 7;
    for(let i=0;i<=ticks;i++){
      const val = (yMax/ticks) * i; const y = yPx(val, yMax);
      chart.appendChild(svgEl('line', { x1:M.l, x2:M.l+IW, y1:y, y2:y, class:'gridline' }));
      chart.appendChild(svgEl('text', { x:M.l-8, y:y+4, 'text-anchor':'end' })).textContent = val.toFixed(2);
    }
    const yl = svgEl('text', { transform:`translate(16 ${M.t+IH/2}) rotate(-90)`, 'text-anchor':'middle' }); yl.textContent='Absorbance (a.u.)'; chart.appendChild(yl);
  }

  function drawLine(yData, color, yMax, dashed){
    const p = svgEl('path', { d: pathFrom(WN, yData, yMax), fill:'none', stroke:color, 'stroke-width': dashed ? 1.4 : 2 });
    if(dashed) p.setAttribute('stroke-dasharray', '6 6');
    chart.appendChild(p);
  }

  function component(def, scale){ return WN.map(wn => def.peaks.reduce((s,p)=> s + p.a * p.fn(wn, p.mu, p.w), 0) * scale); }
  function addVec(a,b){ return a.map((v,i)=> v + b[i]); }

  function state(){
    return {
      mont:+inputs.mont.value, kaol:+inputs.kaol.value, chl:+inputs.chl.value, ill:+inputs.ill.value,
      iw:+inputs.iw.value, aw:+inputs.aw.value, org:+inputs.org.value, nit:+inputs.nit.value, pho:+inputs.pho.value,
      bo:+inputs.bo.value, bs:+inputs.bs.value, normalize:inputs.normalize.checked, showComps:inputs.showComps.checked
    };
  }
  function updateValueLabels(){
    labels.mont.textContent = (+inputs.mont.value).toFixed(2);
    labels.kaol.textContent = (+inputs.kaol.value).toFixed(2);
    labels.chl.textContent  = (+inputs.chl.value).toFixed(2);
    labels.ill.textContent  = (+inputs.ill.value).toFixed(2);
    labels.iw.textContent   = (+inputs.iw.value).toFixed(2);
    labels.aw.textContent   = (+inputs.aw.value).toFixed(2);
    labels.org.textContent  = (+inputs.org.value).toFixed(2);
    labels.nit.textContent  = (+inputs.nit.value).toFixed(2);
    labels.pho.textContent  = (+inputs.pho.value).toFixed(2);
    labels.bo.textContent   = (+inputs.bo.value).toFixed(3);
    labels.bs.textContent   = (+inputs.bs.value).toFixed(5);
  }

  function render(){
    updateValueLabels();
    const s = state();

    const comps = {
      mont: component(defs.montmorillonite, s.mont),
      kaol: component(defs.kaolinite, s.kaol),
      chl:  component(defs.chlorite, s.chl),
      ill:  component(defs.illite, s.ill),
      iw:   component(defs.interlayerWater, s.iw),
      aw:   component(defs.adsorbedWater, s.aw),
      org:  component(defs.organicMatter, s.org),
      nit:  component(defs.nitrate, s.nit),
      pho:  component(defs.phosphateBound, s.pho)
    };

    const baseline = WN.map(wn => s.bo + s.bs * (4000 - wn));

    let total = baseline.slice();
    for(const k in comps) total = addVec(total, comps[k]);

    const maxRaw = Math.max(...total);
    const norm = s.normalize ? (maxRaw || 1) : 1;

    const baselineN = baseline.map(v => v / norm);
    const totalN = total.map(v => v / norm);
    const compsN = {}; for(const k in comps) compsN[k] = comps[k].map(v => v / norm);

    const yMaxNice = Math.ceil((Math.max(...totalN) || 1) / 0.1) * 0.1;

    clearChart();
    drawAxes(yMaxNice);

    drawLine(baselineN, '#64748b', yMaxNice, true);

    if(s.showComps){
      drawLine(compsN.mont, defs.montmorillonite.color, yMaxNice);
      drawLine(compsN.kaol, defs.kaolinite.color, yMaxNice);
      drawLine(compsN.chl,  defs.chlorite.color, yMaxNice);
      drawLine(compsN.ill,  defs.illite.color, yMaxNice);
      drawLine(compsN.iw,   defs.interlayerWater.color, yMaxNice);
      drawLine(compsN.aw,   defs.adsorbedWater.color, yMaxNice);
      drawLine(compsN.org,  defs.organicMatter.color, yMaxNice);
      drawLine(compsN.nit,  defs.nitrate.color, yMaxNice);
      drawLine(compsN.pho,  defs.phosphateBound.color, yMaxNice);
    }

    drawLine(totalN, '#111827', yMaxNice);
  }

  for(const id in inputs){ const el = inputs[id]; if(!el) continue; if(el.tagName === 'BUTTON') continue; el.addEventListener('input', render); }
  inputs.reset.addEventListener('click', ()=>{
    inputs.mont.value=0.8; inputs.kaol.value=0.6; inputs.chl.value=0.4; inputs.ill.value=0.5;
    inputs.iw.value=0.6; inputs.aw.value=0.7; inputs.org.value=0.6; inputs.nit.value=0.5; inputs.pho.value=0.5;
    inputs.bo.value=0.02; inputs.bs.value=0.00003; inputs.normalize.checked=false; inputs.showComps.checked=true;
    render();
  });

  render();
})();
</script>
</body>
</html>
